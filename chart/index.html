<!doctype html>
<html lang="zh">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
		crossorigin="anonymous">

	<title>个人战绩</title>
	<style>
		#chart_rader {
			height: 195px;
		}

		#chart_pie {
			height: 195px;
		}

		#chart_line {
			height: 110px;
		}

		#qqHead {
			height: 140px;
			width: 140px;
		}

		#qqHead2 {
			height: 140px;
			width: 140px;
		}

		body,
		input,
		textarea,
		option,
		select {
			font-family: -apple-system, BlinkMacSystemFont,
				"Microsoft JhengHei", "Meiryo",
				"Malgun Gothic", "tahoma", "Dotum",
				"MS PGothic", "PMingLiu", system,
				system-ui, "Apple Color Emoji",
				"Segoe UI Emoji", "Segoe UI Symbol",
				sans-serif;
		}
	</style>
</head>

<body class="my-3 bg-secondary">
	<div class="container">
		<div class="card shadow-lg">
			<div class="row d-sm-none justify-content-center align-items-center text-center">
				<div class="col-auto">
					<span id="head_input2" class="py-1"></span>
				</div>
				<div class="col-auto">
					<h3 class="card-title mb-0" id="userName2"></h3>
					<span class="badge bg-primary" id="level2"></span>
					<span class="badge bg-secondary">R<span id="rate2">1500</span></span>
					<br>
					<span class="badge bg-secondary rounded-pill" id="club2"></span>
				</div>
			</div>

			<div class="row align-items-center">
				<div class="col-sm-4 col-6">
					<div class="ps-4">
						<span class="json_text badge bg-secondary rounded-pill d-none d-sm-inline-block"
							id="club"></span><br>

						<span class="d-inline-block">全国排行</span>
						<span class="json_text" id="rank"></span><br>

						<span class="json_text d-inline-block" id="areaName"></span>
						<span class="json_text" id="areaRank"></span><br>

						<span class="d-inline-block">总对局数</span>
						<span class="json_text" id="totalCount"></span><br>

						<span class="d-inline-block">飞人吃一</span>
						<span class="json_text" id="killCount"></span>
					</div>
				</div>

				<div class="col-4 text-center d-none d-sm-block">
					<div id="head_input" class="py-1"></div>
					<span class="json_text" id="userName"></span>
					<br>
					<span class="badge bg-primary" id="level"></span>
					<span class="badge bg-secondary">R<span class="json_text" id="rate"></span></span>
				</div>
				<div class="col-sm-4 col-6 text-end">
					<div class="pe-4">
						<span class="d-inline-block">最高点<span class="d-none d-sm-inline-block">数</span></span>
						<span class="json_text" id="maxPoint"></span><br>

						<span class="d-inline-block">平均点<span class="d-none d-sm-inline-block">数</span></span>
						<span class="json_text" id="pointAvg"></span><br>

						<span id="percent"></span><br>

						<span class="d-inline-block"><span class="d-none d-sm-inline-block">升段</span>局数≥<span
								id="lv_count"></span></span>
						(<span class="json_text" id="currentCount"></span>)<br>

						<span class="d-inline-block"><span class="d-none d-sm-inline-block">升段</span>均顺≤<span
								id="lv_avg"></span></span>
						(<span class="json_text" id="currentAvg"></span>)<br>

						<span class="d-none">
							<span class="d-inline-block">通算<span class="d-none d-sm-inline-block">得点</span></span>
							<small id="totalScore"></small>
						</span>

					</div>
				</div>
			</div>

			<div class="row align-items-center">
				<div id="chart_rader" class="col-md-6"></div>
				<div id="chart_pie" class="col-md-6"></div>
			</div>
			<small class="text-center text-muted">最近顺位
				<span id="logs" class="text-break text-wrap"></span>
			</small>
			<div id="chart_line"></div>

			<div class="card-footer text-muted text-center">
				https://rate.000.mk
				<span class="d-none d-sm-inline-block">全国雀庄公式战</span>
				<small id="now">2021-12-28 12:12</small>
			</div>
		</div>
	</div>


	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/echarts@5.2.2/dist/echarts.min.js"></script>
	<script>
		var today = new Date();
		var y = today.getFullYear();
		var m = today.getMonth() + 1;
		var d = today.getDate();
		var h = today.getHours();
		var minutes = today.getMinutes();
		m = m < 10 ? '0' + m : m;
		d = d < 10 ? '0' + d : d;
		h = h < 10 ? '0' + h : h;
		minutes = minutes < 10 ? '0' + minutes : minutes;
		document.getElementById("now").innerText = y + "-" + m + "-" + d + ' ' + h + ":" + minutes;

		var apiurl = "https://000.mk/r/chart.php";
		function image_loaded() {
			var span = document.createElement('span');
			span.id = 'image_loaded';
			document.body.append(span);
		}
		fetch(apiurl + window.location.search)
			.catch(error => alert("fetch失败"))
			.then((response) => response.json())
			.then((json) => {
				if (json.code == 0 && json.hasOwnProperty("msg")) {//成功
					if (json.msg === '需要参数') {
						var userName = prompt('请输入选手昵称');
						return window.location.search = "name=" + userName;
					}
					return alert(json.msg);
				}
				if (json.code == 1) {//成功
					return generateCharts(json)
				}
				if (json.code == 2) {//多重
					var number = prompt(json.msg, 1);
					if (number > 0) {
						return window.location.search += "&area=" + number;
					} else {
						return alert('错误的输入')
					}
				}
				return alert("找不到此选手");
			});

		function generateCharts(jsonData) {

			var levelConfig = [
				['新人', 7, 2.9],
				['五级', 7, 2.8],
				['四级', 10, 2.7],
				['三级', 10, 2.7],
				['二级', 12, 2.6],
				['一级', 16, 2.6],
				['初段', 16, 2.5],
				['二段', 20, 2.5],
				['三段', 25, 2.4],
				['四段', 25, 2.4],
				['五段', 30, 2.3],
				['六段', 40, 2.1],
				['七段', 45, 2.0],
				['八段', 50, 1.9],
				['九段', 1, 0],
			];
			if (jsonData.radar[0] == 0) { //火力怪异现象
				jsonData.radar[0] = null;
			}
			var img = document.createElement('img');
			img.id = 'qqHead';
			img.setAttribute('src', "https://q1.qlogo.cn/g?b=qq&s=640&nk=" + jsonData.qq);
			img.setAttribute('class', "img-thumbnail rounded-circle shadow-sm");
			img.setAttribute('onload', 'image_loaded()');
			document.getElementById('head_input').appendChild(img);
			var img = document.createElement('img');
			img.id = 'qqHead2';
			img.setAttribute('src', "https://q1.qlogo.cn/g?b=qq&s=640&nk=" + jsonData.qq);
			img.setAttribute('class', "img-thumbnail rounded-circle shadow-sm");
			document.getElementById('head_input2').appendChild(img);
			document.getElementById('rate2').innerText = jsonData.rate;
			document.getElementById('userName2').innerText = jsonData.userName;
			document.getElementById('club2').innerText = jsonData.club;
			document.getElementById('level').innerText = levelConfig[jsonData.level][0];
			document.getElementById('level2').innerText = levelConfig[jsonData.level][0];
			document.getElementById('lv_count').innerText = levelConfig[jsonData.level][1];
			document.getElementById('lv_avg').innerText = levelConfig[jsonData.level][2];
			if (jsonData.percent == 100) { jsonData.percent = 99.9; }
			document.getElementById('percent').innerText =
				(jsonData.totalCount == 0 || jsonData.percent <= 10)
					? '未来可期的雀士' : '击败了' + jsonData.percent + '%雀士';
			document.getElementById('currentAvg').className +=
				(jsonData.currentAvg <= levelConfig[jsonData.level][2]) ?
					' text-success' : ' text-danger';
			if (jsonData.currentCount >= levelConfig[jsonData.level][1]) {
				document.getElementById('currentCount').className += ' text-success';
				document.getElementById('currentCount').innerText = '完成';
			} else {
				document.getElementById('currentCount').className += ' text-danger';
			}

			var str = '', logs = jsonData['logs'];
			for (var i = 0; i < logs.length; i += 5) {
				str += logs.slice(i, i + 5).join('') + ' ';
			}
			if (i % 5 > 0) {
				str += logs.slice(0 - (i % 5)).join('');
			}

			document.getElementById('logs').innerText = str;
			var totalScore = document.getElementById('totalScore');
			if (jsonData['totalScore'] >= 0) {//text-success
				totalScore.innerText = '+' + jsonData['totalScore'];
				totalScore.className = 'text-success';
			} else {
				totalScore.innerText = jsonData['totalScore'];
				totalScore.className = 'text-danger';
			}
			var myClass = document.getElementsByClassName("json_text");
			for (let i = 0; i < myClass.length; i++) {
				const element = myClass[i];
				element.innerText = jsonData[element.id];
			}
			var myChart = echarts.init(document.getElementById("chart_rader"));
			var myChart2 = echarts.init(document.getElementById("chart_line"));
			var myChart3 = echarts.init(document.getElementById("chart_pie"));
			var app = {};
			var option = {
				legend: { show: false },
				tooltip: { show: true, },
				radar: {
					// shape: 'circle',
					indicator: [
						{ name: '火力 (一位时平均点数)', max: 47000, min: 35000 },
						{ name: '防守 (不飞率)', max: 0.9, min: 0.3 },
						{ name: '稳定 (连对率)', max: 0.6 },
						{ name: '运势 (近十战平均顺位)', max: 2.8 },
						{ name: '技术 (Rate)', max: 1800, min: 1300 },
						{ name: '进攻 (一位率)', max: 0.35 }
					],
					//center: ['25%', '50%'],
					radius: "65%",
					axisName: {
						color: '#333',
						fontWeight: 'bold',
					},
				},
				series: [
					{
						type: 'radar',
						symbolSize: 6,
						data: [
							{
								value: jsonData.radar,
								areaStyle: {
									color: 'rgba(30, 200, 255, 0.6)'
								}
							}
						]
					},
				]
			};
			var option3 = {
				legend: { show: false },
				tooltip: { show: true, },
				series: [
					{
						//center: ['70%', '50%'],
						type: 'pie',
						radius: ['35%', '70%'],
						itemStyle: {
							borderRadius: 5,
							borderColor: '#fff',
							borderWidth: 2
						},
						label: {
							show: true,
							formatter: '{d}%\n{c}回{b}'
						},
						labelLine: {
							length: 10,
							length2: 15,
						},
						data: jsonData.pie
					},

				]
			};

			var option2 = {
				legend: {
					show: false
				},
				tooltip: { show: true, },
				grid: {
					left: '7%',
					right: '7%',
					top: '5%',
					bottom: 0,
					containLabel: true
				},
				xAxis: {
					type: 'category',
					show: false,
					boundaryGap: false,
				},
				yAxis: {
					type: 'value'
				},
				series: [
					{
						data: jsonData.recent,
						type: 'line',
						symbol: 'circle',
						symbolSize: 5,
						smooth: true,
						areaStyle: {
							opacity: 0.7,
							color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
								{
									offset: 0,
									color: 'rgb(128, 255, 165)'
								},
								{
									offset: 1,
									color: 'rgb(1, 191, 236)'
								}
							])
						},
					}
				]
			};

			if (option && typeof option === 'object') {
				myChart.setOption(option);
				myChart2.setOption(option2);
				myChart3.setOption(option3);
				window.onresize = function () {
					myChart.resize();
					myChart2.resize();
					myChart3.resize();
				};
			}
		}

	</script>

</body>

</html>