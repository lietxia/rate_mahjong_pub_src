<!DOCTYPE html>
<html lang="zh">

<head>
	<meta charset="UTF-8">
	<meta content="width=device-width, initial-scale=1.0" name="viewport">
	<title>Add log</title>
	<link href="https://cdn.staticfile.org/twitter-bootstrap/4.6.1/css/bootstrap.min.css" rel="stylesheet"/>
	<link href="https://cdn.staticfile.org/bootswatch/4.6.1/darkly/bootstrap.min.css"
	      media="(prefers-color-scheme: dark)"
	      rel="stylesheet"/>
	<style>
		body,
		input,
		textarea {
			font-family: "Microsoft JhengHei", "Meiryo", "Malgun Gothic", "Dotum", "MS PGothic", "PMingLiu", sans-serif;
		}

		body {
			background-color: #999;
		}

		@media (prefers-color-scheme: dark) {
			body {
				background: #222;
			}
		}
	</style>
</head>

<body>
<div class="container my-4">

	<div id="return_msg"></div>

	<div class="card shadow mb-3">
		<div class="card-header text-center">記錄管理 名單管理</div>

		<div class="card-body">
			<div class="input-group mb-3">
				<div class="input-group-prepend">
					<span class="input-group-text">雀庄编号</span>
				</div>
				<input class="form-control" id="input_cid" onchange="get_n2phone()" type="number" value="1"/>
				<div class="input-group-prepend">
					<span class="input-group-text">雀庄密碼</span>
				</div>
				<input class="form-control" id="input_password" type="password" value=""/>
			</div>
			<!-- Nav tabs -->
			<ul class="nav nav-tabs justify-content-center" id="myTab" role="tablist">
				<li class="nav-item" role="presentation">
					<a aria-controls="import_excel" aria-selected="true" class="nav-link active" data-toggle="tab"
					   href="#import_excel"
					   id="excel-tab" role="tab">表格導入</a>
				</li>
				<li class="nav-item" role="presentation">
					<a aria-controls="add_log" aria-selected="false" class="nav-link" data-toggle="tab" href="#add_log"
					   id="add-tab"
					   role="tab">添加記錄</a>
				</li>
				<li class="nav-item" role="presentation">
					<a aria-controls="edit_members" aria-selected="false" class="nav-link" data-toggle="tab"
					   href="#edit_members"
					   id="members-tab" role="tab">修改名單</a>
				</li>
				<li class="nav-item" role="presentation">
					<a aria-controls="del_log" aria-selected="false" class="nav-link" data-toggle="tab" href="#del_log"
					   id="del-tab"
					   role="tab">刪除記錄</a>
				</li>
			</ul><!-- Nav end -->

			<!-- Tab panes -->
			<div class="tab-content">

				<form aria-labelledby="excel-tab" class="tab-pane active" id="import_excel" role="tabpanel">

					<p class="mt-3">
						請用這個Excel文件，記錄線下成績：<a href="dashulin.xlsx">dashulin.xlsx</a></p>
					<div class="input-group my-3">
						<div class="input-group-prepend">
							<span class="input-group-text">記錄</span>
						</div>
						<textarea class="form-control" name="excel_text" onchange="check_excel(this)"
						          placeholder="打開Excel，全選，粘貼到這，提交"
						          rows="5"></textarea>

					</div>
					<p id="excel_info"></p>
					<input class="btn btn-primary btn-block d-none" id="btn_excel" onclick="post_data('import_excel')"
					       type="button"
					       value="表格導入"/>
				</form>

				<form aria-labelledby="add_log-tab" class="tab-pane" id="add_log" role="tabpanel">

					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<span class="input-group-text">階段</span>
						</div>
						<input class="form-control" name="acid" type="number" value="1"/>
						<div class="input-group-prepend">
							<span class="input-group-text">時間</span>
						</div>
						<input class="form-control" id="logtime" name="logtime" type="text"/>
					</div>
					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<span class="input-group-text">備註</span>
						</div>
						<input class="form-control" name="note" placeholder="可不填，≤20字" type="text"/>
					</div>

					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<span class="input-group-text">名字</span>
						</div>
						<input class="form-control" id="name1" placeholder="必填" type="text"/>
						<input id="phone1" name="phone1" type="hidden" value=""/>
						<input id="phone2" name="phone2" type="hidden" value=""/>
						<input id="phone3" name="phone3" type="hidden" value=""/>
						<input id="phone4" name="phone4" type="hidden" value=""/>

					</div>

					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<span class="input-group-text">點數</span>
						</div>
						<input class="form-control" name="point1" onchange="fmt(this,true)" placeholder="結束點數，必填"
						       type="text"/>
						<div class="input-group-prepend">
							<span class="input-group-text">積分</span>
						</div>
						<input class="form-control" name="score1" onchange="fmt(this,true)" placeholder="只能整數，必填"
						       type="text"/>
					</div>
					<hr/>
					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<span class="input-group-text">名字</span>
						</div>
						<input class="form-control" id="name2" placeholder="必填" type="text"/>


					</div>

					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<span class="input-group-text">點數</span>
						</div>
						<input class="form-control" name="point2" onchange="fmt(this,true)" placeholder="結束點數，必填"
						       type="text"/>
						<div class="input-group-prepend">
							<span class="input-group-text">積分</span>
						</div>
						<input class="form-control" name="score2" onchange="fmt(this,true)" placeholder="只能整數，必填"
						       type="text"/>
					</div>
					<hr/>
					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<span class="input-group-text">名字</span>
						</div>
						<input class="form-control" id="name3" placeholder="必填" type="text"/>

					</div>

					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<span class="input-group-text">點數</span>
						</div>
						<input class="form-control" name="point3" onchange="fmt(this,true)" placeholder="結束點數，必填"
						       type="text"/>
						<div class="input-group-prepend">
							<span class="input-group-text">積分</span>
						</div>
						<input class="form-control" name="score3" onchange="fmt(this,true)" placeholder="只能整數，必填"
						       type="text"/>
					</div>
					<hr/>
					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<span class="input-group-text">名字</span>
						</div>
						<input class="form-control" id="name4" placeholder="必填" type="text"/>

					</div>

					<div class="input-group mt-3">
						<div class="input-group-prepend">
							<span class="input-group-text">點數</span>
						</div>
						<input class="form-control" name="point4" onchange="fmt(this,true)" placeholder="結束點數，必填"
						       type="text"/>
						<div class="input-group-prepend">
							<span class="input-group-text">積分</span>
						</div>
						<input class="form-control" name="score4" onchange="fmt(this,true)" placeholder="只能整數，必填"
						       type="text"/>
					</div>
					<div class="custom-control custom-checkbox m-2">
						<input class="custom-control-input" id="logtype" name="logtype" type="checkbox">
						<label class="custom-control-label" for="logtype">並非對戰記錄，只是用來調整成績</label>
					</div>
					<input class="btn btn-primary btn-block" onclick="check_add_log()" type="button" value="添加記錄"/>

				</form>

				<form aria-labelledby="members-tab" class="tab-pane" id="edit_members" role="tabpanel">

					<p class="mt-3">輸入示例如下：<br/>
						<kbd>QQ號1</kbd> <kbd>空格</kbd> <kbd>張三</kbd><br/>
						<kbd>QQ號2</kbd> <kbd>空格</kbd> <kbd>李四</kbd><br/>
						<kbd>QQ號2</kbd> <kbd>空格</kbd> <kbd>小四</kbd><br/>
						<kbd>-1</kbd> <kbd>空格</kbd> <kbd>王五</kbd><br/>
						※支持「一人多名字」，寫2行即可（示例第2～3行）<br/>
						※多名字時，外面只顯示<kbd>最下方的名字</kbd>，系統會區分大小寫<br/>
						※名字不支持空格，名字≤15字<br/>
						※如果那個人沒有QQ，QQ用<kbd>負數</kbd>表示（示例第4行），負值是多少無所謂，同賽事內不撞車即可。
					</p>

					<div class="input-group my-3">
						<div class="input-group-prepend">
							<span class="input-group-text">名單</span>
						</div>
						<textarea class="form-control" id="input_members" name="input_members" rows="5"></textarea>
					</div>
					<input class="btn btn-primary btn-block" onclick="post_data('edit_members')" type="button"
					       value="修改名單"/>
				</form>

				<form aria-labelledby="del-tab" class="tab-pane" id="del_log" role="tabpanel">
					<div class="input-group my-3">
						<div class="input-group-prepend">
							<span class="input-group-text">要刪除的階段</span>
						</div>
						<input class="form-control" id="del_acid" name="del_acid" placeholder="正整數" type="text"/>
					</div>
					<input class="btn btn-danger btn-block" onclick="check_delete()" type="button" value="刪除此階段全部記錄"/>
				</form>

			</div><!-- Tab end -->

		</div><!-- card body end -->
	</div><!-- card end -->
</div>
<script crossorigin="anonymous" src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>
<script crossorigin="anonymous"
        src="https://cdn.staticfile.org/twitter-bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>
<script>
	window.n2phone = {};
	window.apiurl = "https://cdn.r-mj.com/api/"
	window.excel_data = {};

	function get_n2phone() {
		var cid = document.getElementById("input_cid").value;
		$.ajax({
			url: window.apiurl + "rate.php",
			method: "POST",
			dataType: "json",
			data: {"q": "name2phone", "cid": cid}
		}).done(function (json) {
			var target = document.getElementById("input_members");
			target.value = "";
			window.n2phone[cid] = json;
			display_post({status: 3, text: "賽事CID" + cid + " 成員名單已加載"});
			var txt = "";
			for (var name in json) {
				if (json.hasOwnProperty(name)) {
					var qq = json[name];
					txt += json[name] + " " + name + "\n"
				}
			}
			target.value = txt.trim();
		}).fail(function (jqXHR, textStatus) {
			console.log(jqXHR, textStatus)
		});
	}

	function now_time() {
		var now = new Date();
		return now.getFullYear() + "/"
			+ (now.getMonth() + 1) + "/"
			+ now.getDate() + " "
			+ now.getHours() + ":"
			+ now.getMinutes() + ":"
			+ now.getSeconds();
	}

	(function () {
		document.getElementById("logtime").value = now_time()
		get_n2phone();
	})()

	function check_add_log() {
		var qqarr = [], err = [];
		for (var i = 1; i <= 4; i++) {
			var e = document.getElementById("name" + i);
			var n2phone = window.n2phone[document.getElementById("input_cid").value];
			if (n2phone.hasOwnProperty(e.value)) {
				qqarr.push(n2phone[e.value]);
				document.getElementById("qq" + i).value = n2phone[e.value];
			} else {
				err.push(e.value);
				document.getElementById("qq" + i).value = "";
			}
		}
		if (qqarr.length == 4) {
			return post_data('add_log');
		} else {
			return display_post({status: 2, text: "这些ID无法识别: " + err.join(" ")});
		}
	}


	/*
	han2u = (han = "漢字") => {
	  var str = "";
	  han.split("").map((v) => str += "\\u" + (v.codePointAt(0).toString(16)));
	  return str;
	};
	*/

	function fmt(that, conv_int) {
		if (isNaN(that.value)) {
			return that.value = "";
		}
		return that.value = (conv_int) ?
			parseInt(that.value) :
			Math.round(that.value * 1000) / 1000;
	}

	function check_delete() {
		var o = document.getElementById("del_acid").value;
		o = parseInt(o);
		if (!o > 0) {
			return
		}
		var re = prompt("再輸入一次要刪除的階段");
		re = parseInt(re);
		if (re > 0 && re === o) {
			post_data("del_log");
		}
	}

	function post_data(order) {
		var type = ["import_excel", "add_log", "edit_members", "del_log"];
		if (type.indexOf(order) < 0) {
			return display_post({status: 2, text: "非法操作#287"});
		}

		if (order === "import_excel") {
			var postdata = {
				"q": "import_excel",
				"pw": document.getElementById("input_password").value,
				"cid": document.getElementById("input_cid").value,
				"excel_data": window.excel_data
			}
		} else {
			var postdata = $("#" + order).serializeArray();
			postdata.push({"name": "q", "value": order});
			postdata.push({"name": "cid", "value": document.getElementById("input_cid").value});
			postdata.push({"name": "pw", "value": document.getElementById("input_password").value});
		}

		$.ajax({
			url: window.apiurl + "rate.php",
			method: "POST",
			dataType: "json",
			data: postdata
		}).done(function (json) {
			display_post(json);
			if (order === "edit_members" && json["status"] != 2) {
				get_n2phone();
			}
		}).fail(function (jqXHR, textStatus) {
			console.log(jqXHR, textStatus)
		});
	}

	function display_post(json) {
		var now = now_time();
		if (json.hasOwnProperty("status") == false || json.hasOwnProperty("text") == false) {
			json = {"status": 1, "text": "返回空"}
		}
		if (typeof json.text === "object") {
			json.text = JSON.stringify(json.text);
		}
		console.log(json);
		var div = document.createElement("div");
		var color = ["success", "warning", "danger", "info"];
		div.setAttribute("class", "alert alert-" + color[json.status] + " alert-dismissible fade show shadow-sm");
		div.setAttribute("role", "alert");
		div.appendChild(document.createTextNode(now + " " + json.text));
		var btn = document.createElement("button");
		btn.setAttribute("class", "close");
		btn.setAttribute("data-dismiss", "alert");
		btn.setAttribute("aria-label", "Close");
		var span = document.createElement("span");
		span.innerHTML = "&times;";
		btn.appendChild(span);
		div.appendChild(btn);
		var tgt = document.getElementById("return_msg")
		tgt.insertBefore(div, tgt.childNodes[0]);
	}

	function check_excel(that) {
		var n2phone = window.n2phone[document.getElementById("input_cid").value];
		var err = [];

		var val = that.value.split("\n");
		var out = [];
		var fmt_int = [0, 2, 5, 6, 9, 10, 13, 14, 17, 18];
		var player_name = [4, 8, 12, 16];
		var fmt_float = [7, 11, 15, 19];

		for (var index = 0; index < val.length; index++) {
			var thisrow = val[index].split("\t");
			if (thisrow.length >= 19 && val[index][0] != "#") {

				for (var i = 0; i < thisrow.length; i++) {
					if (fmt_int.indexOf(i) >= 0) {
						thisrow[i] = Math.round(thisrow[i]) || 0;
					}
					if (fmt_float.indexOf(i) >= 0) {
						thisrow[i] = Math.round(thisrow[i] * 1000) / 1000 || 0;
					}
					if (player_name.indexOf(i) >= 0) {
						if (n2phone.hasOwnProperty(thisrow[i])) {
							thisrow[i] = n2phone[thisrow[i]];
						} else {
							err.push(thisrow[i]);
						}
					}
				}
				out.push(thisrow);
			}
		}
		window.excel_data = out;
		var print_e = document.getElementById("excel_info");
		if (err.length === 0) {
			if (out.length === 0) {
				print_e.innerText = "請粘貼正確的數據";
			} else {
				print_e.innerText = "成功識別" + out.length + "行記錄";
				$("#btn_excel").removeClass("d-none");
			}
			return;
		} else {
			print_e.innerText = "以下名字不能識別\n" + err.join("\n");
		}
		return
	}
</script>

</body>

</html>